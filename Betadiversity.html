<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Leo Lahti, Sudarshan Shetty et al. 2019-07-23" />


<title>Beta diversity and microbiome divergence</title>

<script src="Betadiversity_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="Betadiversity_files/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet" />
<script src="Betadiversity_files/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script src="Betadiversity_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<script src="Betadiversity_files/navigation-1.1/tabsets.js"></script>
<script src="Betadiversity_files/navigation-1.1/codefolding.js"></script>
<link href="Betadiversity_files/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
<script src="Betadiversity_files/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
<link href="Betadiversity_files/readthedown-0.1/readthedown.css" rel="stylesheet" />
<script src="Betadiversity_files/readthedown-0.1/readthedown.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
</style>


</head>

<body>


<div id="content" data-toggle="wy-nav-shift">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->

<nav id="nav-top" role="navigation" aria-label="top navigation">
    <a role="button" href="#" data-toggle="wy-nav-top"><span class="glyphicon glyphicon-menu-hamburger"></span></a>
</nav>


<div id="header">
<h1 class="title">Beta diversity and microbiome divergence</h1>
</div>


<div id="table-of-contents">
    <h2><a href="#content">Beta diversity and microbiome divergence</a></h2>
    <div id="text-table-of-contents">
      <ul>
      <li><a href="#beta-diversity">Beta diversity</a></li>
      <li><a href="#quantifying-group-divergence-spread">Quantifying group divergence / spread</a></li>
      <li><a href="#intra-individual-divergence">Intra-individual divergence</a></li>
      <li><a href="#beta-diversity-within-individual-over-time">Beta diversity within individual over time</a></li>
      </ul>
    </div>
</div>

<div id="main">
<!--
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{microbiome tutorial - variability}
  %\usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}  
-->
<div id="beta-diversity" class="section level2">
<h2>Beta diversity</h2>
<p>Some examples on calculating beta diversity and using it to quantify community divergence within a given sample set.</p>
<p>See <a href="Comparisons.html">Community comparisons</a> page for examples on group-level comparisons based on beta diversity measures, including <a href="limma.html">limma</a>, <a href="PERMANOVA.html">PERMANOVA</a>, <a href="Mixedmodels.html">mixed models</a>, and <a href="Negativebinomial.html">negative binomial</a>.</p>
<p>Load example data</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(microbiome)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">data</span>(peerj32)</a>
<a class="sourceLine" id="cb1-4" title="4">pseq &lt;-<span class="st"> </span>peerj32<span class="op">$</span>phyloseq</a></code></pre></div>
</div>
<div id="quantifying-group-divergence-spread" class="section level2">
<h2>Quantifying group divergence / spread</h2>
<p>Divergence of a given sample set can be quantified as the average dissimilarity of each sample from the group mean; the dissimilarity can be quantified by beta diversity, for instance. This was applied in group-level comparisons for instance in <a href="http://www.nature.com/ismej/journal/v8/n11/full/ismej201463a.html">Salonen et al. ISME J 2014</a> (they focused on homogeneity using inverse correlation, whereas here we focus on divergence using correlation but the measure is essentially the same).</p>
<p>Calculate group divergences within the LGG (probiotic) and Placebo groups</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">b.pla &lt;-<span class="st"> </span><span class="kw">divergence</span>(<span class="kw">subset_samples</span>(pseq, group <span class="op">==</span><span class="st"> &quot;Placebo&quot;</span>))</a>
<a class="sourceLine" id="cb2-2" title="2">b.lgg &lt;-<span class="st"> </span><span class="kw">divergence</span>(<span class="kw">subset_samples</span>(pseq, group <span class="op">==</span><span class="st"> &quot;LGG&quot;</span>))</a></code></pre></div>
<p>Use these to compare microbiota divergence within each group. The LGG group tends to have smaller values, indicating that the samples are more similar to the group mean, and the LGG group is less heterogeneous (has smaller spread / is more homogeneous):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">boxplot</span>(<span class="kw">list</span>(<span class="dt">LGG =</span> b.lgg, <span class="dt">Placebo =</span> b.pla))</a></code></pre></div>
<p><img src="Betadiversity_files/figure-html/divergence-example2bbb-1.png" width="300px" /></p>
<p>The <strong>inter- and intra-invididual stability</strong> (or homogeneity) measures are obtained as 1-b where b is the group divergence with the anticorrelation method (<a href="http://www.nature.com/ismej/journal/v8/n11/full/ismej201463a.html">Salonen et al. ISME J 2014</a>).</p>
</div>
<div id="intra-individual-divergence" class="section level2">
<h2>Intra-individual divergence</h2>
<p>Quantify beta diversity within subjects over time (as in <a href="http://www.nature.com/ismej/journal/v8/n11/full/ismej201463a.html">Salonen et al. ISME J 2014</a> for intra-individual stability)</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">betas &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb4-2" title="2">groups &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">unique</span>(<span class="kw">meta</span>(pseq)<span class="op">$</span>group))</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="cf">for</span> (g <span class="cf">in</span> groups) {</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="co">#df &lt;- meta(subset_samples(pseq, group == g))</span></a>
<a class="sourceLine" id="cb4-5" title="5">  df &lt;-<span class="st"> </span><span class="kw">subset</span>(<span class="kw">meta</span>(pseq), group <span class="op">==</span><span class="st"> </span>g)</a>
<a class="sourceLine" id="cb4-6" title="6">  beta &lt;-<span class="st"> </span><span class="kw">c</span>()</a>
<a class="sourceLine" id="cb4-7" title="7"></a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="cf">for</span> (subj <span class="cf">in</span> df<span class="op">$</span>subject) {</a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="co"># Pick the samples for this subject</span></a>
<a class="sourceLine" id="cb4-10" title="10">    dfs &lt;-<span class="st"> </span><span class="kw">subset</span>(df, subject <span class="op">==</span><span class="st"> </span>subj)</a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="co"># Check that the subject has two time points</span></a>
<a class="sourceLine" id="cb4-12" title="12">    <span class="cf">if</span> (<span class="kw">nrow</span>(dfs) <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb4-13" title="13">      s &lt;-<span class="st"> </span><span class="kw">as.character</span>(dfs<span class="op">$</span>sample)</a>
<a class="sourceLine" id="cb4-14" title="14">      <span class="co"># Here with just two samples we can calculate the</span></a>
<a class="sourceLine" id="cb4-15" title="15">      <span class="co"># beta diversity directly</span></a>
<a class="sourceLine" id="cb4-16" title="16">      beta[[subj]] &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">-</span><span class="kw">cor</span>(<span class="kw">abundances</span>(pseq)[, s[[<span class="dv">1</span>]]],</a>
<a class="sourceLine" id="cb4-17" title="17">                        <span class="kw">abundances</span>(pseq)[, s[[<span class="dv">2</span>]]],</a>
<a class="sourceLine" id="cb4-18" title="18">                <span class="dt">method =</span> <span class="st">&quot;spearman&quot;</span>)</a>
<a class="sourceLine" id="cb4-19" title="19">    }</a>
<a class="sourceLine" id="cb4-20" title="20">  }</a>
<a class="sourceLine" id="cb4-21" title="21">  betas[[g]] &lt;-<span class="st"> </span>beta</a>
<a class="sourceLine" id="cb4-22" title="22">}</a>
<a class="sourceLine" id="cb4-23" title="23"></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="kw">boxplot</span>(betas)</a></code></pre></div>
<p><img src="Betadiversity_files/figure-html/homogeneity-example2c-1.png" width="300px" /></p>
</div>
<div id="beta-diversity-within-individual-over-time" class="section level2">
<h2>Beta diversity within individual over time</h2>
<p>Calculate change in beta diversity (community dissimilarity) over time within a single individual</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">data</span>(atlas1006)</a>
<a class="sourceLine" id="cb5-2" title="2">pseq &lt;-<span class="st"> </span>atlas1006</a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co"># Identify subject with the longest time series (most time points)</span></a>
<a class="sourceLine" id="cb5-5" title="5">s &lt;-<span class="st"> </span><span class="kw">names</span>(<span class="kw">which.max</span>(<span class="kw">sapply</span>(<span class="kw">split</span>(<span class="kw">meta</span>(pseq)<span class="op">$</span>time, <span class="kw">meta</span>(pseq)<span class="op">$</span>subject), <span class="cf">function</span> (x) {<span class="kw">length</span>(<span class="kw">unique</span>(x))})))</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co"># Pick the metadata for this subject and sort the</span></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co"># samples by time</span></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb5-10" title="10">df &lt;-<span class="st"> </span><span class="kw">meta</span>(pseq) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(subject <span class="op">==</span><span class="st"> </span>s) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(time)</a>
<a class="sourceLine" id="cb5-11" title="11"></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="co"># Calculate the beta diversity between each time point and</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="co"># the baseline (first) time point</span></a>
<a class="sourceLine" id="cb5-14" title="14">beta &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>) <span class="co"># Baseline similarity</span></a>
<a class="sourceLine" id="cb5-15" title="15">s0 &lt;-<span class="st"> </span><span class="kw">subset</span>(df, time <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)<span class="op">$</span>sample</a>
<a class="sourceLine" id="cb5-16" title="16"><span class="cf">for</span> (tp <span class="cf">in</span> df<span class="op">$</span>time[<span class="op">-</span><span class="dv">1</span>]) {</a>
<a class="sourceLine" id="cb5-17" title="17">  <span class="co"># Pick the samples for this subject</span></a>
<a class="sourceLine" id="cb5-18" title="18">  <span class="co"># If the same time point has more than one sample,</span></a>
<a class="sourceLine" id="cb5-19" title="19">  <span class="co"># pick one at random</span></a>
<a class="sourceLine" id="cb5-20" title="20">  st &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">subset</span>(df, time <span class="op">==</span><span class="st"> </span>tp)<span class="op">$</span>sample, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-21" title="21">  a &lt;-<span class="st"> </span><span class="kw">abundances</span>(pseq)</a>
<a class="sourceLine" id="cb5-22" title="22">  b &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">cor</span>(a[, s0], a[, st], <span class="dt">method =</span> <span class="st">&quot;spearman&quot;</span>)</a>
<a class="sourceLine" id="cb5-23" title="23">  beta &lt;-<span class="st"> </span><span class="kw">rbind</span>(beta, <span class="kw">c</span>(tp, b))</a>
<a class="sourceLine" id="cb5-24" title="24">}</a>
<a class="sourceLine" id="cb5-25" title="25"><span class="kw">colnames</span>(beta) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;beta&quot;</span>)</a>
<a class="sourceLine" id="cb5-26" title="26">beta &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(beta)</a>
<a class="sourceLine" id="cb5-27" title="27"></a>
<a class="sourceLine" id="cb5-28" title="28"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb5-29" title="29">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(beta, <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> beta)) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-30" title="30"><span class="st">       </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a>
<a class="sourceLine" id="cb5-31" title="31"><span class="kw">print</span>(p)       </a></code></pre></div>
<p><img src="Betadiversity_files/figure-html/homogeneity-example2d-1.png" width="300px" /></p>
</div>
</div>


</div>

<div id="postamble" data-toggle="wy-nav-shift" class="status">
<p class="author"><span class="glyphicon glyphicon-user"></span> Leo Lahti, Sudarshan Shetty et al. 2019-07-23</p>
</div>


<script>
$(document).ready(function () {
 	 	$('#content img')
 	  .addClass("image-thumb");
      $('#content img')
 	  .addClass("image-lb");
  $('#content').magnificPopup({
	      type:'image',
	      closeOnContentClick: false,
	      closeBtnInside: false,
	      delegate: 'img',
	      gallery: {enabled: true },
	      image: {
	        verticalFit: true,
          titleSrc: 'alt'
	      }
 	    });
 	});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
